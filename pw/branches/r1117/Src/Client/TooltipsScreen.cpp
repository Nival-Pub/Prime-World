#include "stdafx.h"
#include "Tooltips.h"
#include "TooltipsScreen.h"
#include "TooltipsScreenLogic.h"
#include "../Client/ScreenCommands.h"
#include "../Client/MainTimer.h"
#include "../UI/Root.h"
#include "../UI/ScreenLogicBase.h"

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
namespace NMainLoop
{

static Weak<TooltipsScreen> g_instance;

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void TooltipsScreen::CreateScreen()
{
  if( !g_instance )
  {
    TooltipsScreen* screen = new TooltipsScreen();
    NScreenCommands::PushCommand( NScreenCommands::CreatePushScreenCommand( screen ) );
    g_instance = screen;
  }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
TooltipsScreen * TooltipsScreen::Instance()
{
  return g_instance ? g_instance : NULL;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
TooltipsScreen::TooltipsScreen()
{
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
bool TooltipsScreen::Init( UI::User * uiUser )
{
	pLogic = new UI::TooltipsScreenLogic;
  SetLogic( pLogic );
  pLogic->SetUser( uiUser );
	pLogic->LoadScreenLayout( "Tooltips" );
	return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void TooltipsScreen::AddTooltip( const wstring & text, const UI::STooltipDesc & desc )
{
	if ( !pLogic )
		return;
	return pLogic->AddTooltip( text, desc );
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void TooltipsScreen::OnNewFront( IScreenBase *pScreen )
{
  DefaultScreenBase::OnNewFront( pScreen );

  if( pScreen )
    if( pScreen->GetScreenLayer() > NMainLoop::EScreenLayer::AboveTopmost )
      return;

	if ( pLogic )
		pLogic->SetCurrentScreen( pScreen );
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void TooltipsScreen::CommonStep( bool bAppActive )
{
  DefaultScreenBase::CommonStep( bAppActive );

  if ( pLogic )
  {
    if ( !bAppActive )
      pLogic->HideTooltip();

    pLogic->CheckTooltip();
  }
}

} //namespace NMainLoop

NI_DEFINE_REFCOUNT( NMainLoop::TooltipsScreen );
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
